<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Instant Roof Estimate</title>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD5W9aPwPQQPFXHf4uzYeSAmC8nC15wXsM&libraries=places&callback=initMap" async defer></script>

<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: #0a0e14;
  color: #fff;
  padding: 20px;
  min-height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
}
.container {
  max-width: 500px;
  width: 100%;
  background: linear-gradient(180deg, #0f1b2d, #0c1624);
  border-radius: 16px;
  padding: 40px;
  border: 1px solid #243246;
  box-shadow: 0 8px 32px rgba(0,0,0,0.5);
}
h1 {
  text-align: center;
  font-size: 32px;
  margin-bottom: 8px;
}
.subtitle {
  text-align: center;
  color: #9fb3c8;
  margin-bottom: 32px;
  font-size: 16px;
}
.step {
  display: none;
}
.step.active {
  display: block;
  animation: fadeIn 0.3s;
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
label {
  display: block;
  margin-bottom: 8px;
  font-weight: 600;
}
input {
  width: 100%;
  padding: 14px;
  border-radius: 8px;
  background: #0a0e14;
  border: 1px solid #2c3e55;
  color: #fff;
  font-size: 16px;
  margin-bottom: 4px;
}
input:focus {
  outline: none;
  border-color: #3bbcff;
}
.buttons {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
  margin: 16px 0;
}
.btn {
  padding: 16px 12px;
  border-radius: 8px;
  background: #0a0e14;
  border: 2px solid #2c3e55;
  color: #fff;
  font-size: 15px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
}
.btn:hover {
  border-color: #3bbcff;
  background: rgba(59,188,255,0.1);
}
.btn.selected {
  background: #3bbcff;
  border-color: #3bbcff;
  color: #0a0e14;
  font-weight: 600;
}
.primary {
  width: 100%;
  padding: 16px;
  background: linear-gradient(90deg, #3bbcff, #1f8fff);
  border: none;
  border-radius: 8px;
  color: #fff;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  margin-top: 20px;
  transition: transform 0.2s;
}
.primary:hover {
  transform: translateY(-2px);
}
.primary:active {
  transform: translateY(0);
}
.loading, .result {
  display: none;
  text-align: center;
  padding: 40px 20px;
}
.loading.active, .result.active {
  display: block;
}
.spinner {
  border: 4px solid #2c3e55;
  border-top: 4px solid #3bbcff;
  border-radius: 50%;
  width: 60px;
  height: 60px;
  animation: spin 1s linear infinite;
  margin: 0 auto 20px;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
.loading h2 {
  font-size: 24px;
  margin-bottom: 12px;
}
.loading p {
  color: #9fb3c8;
  font-size: 15px;
}
.result h2 {
  font-size: 24px;
  margin-bottom: 16px;
  color: #4ade80;
}
.price {
  font-size: 56px;
  font-weight: 700;
  color: #3bbcff;
  margin: 20px 0;
  text-shadow: 0 2px 8px rgba(59,188,255,0.4);
}
.note {
  color: #9fb3c8;
  font-size: 14px;
  line-height: 1.5;
  margin-top: 16px;
}
</style>
</head>

<body>
<div class="container">

<h1>Instant Roof Estimate</h1>
<div class="subtitle">Answer a few quick questions</div>

<div class="step active" id="step1">
  <label>First Name</label>
  <input type="text" id="firstName" placeholder="Enter your first name">
  <button class="primary" onclick="goToStep(2)">Next</button>
</div>

<div class="step" id="step2">
  <label>Email</label>
  <input type="email" id="email" placeholder="your@email.com">
  <button class="primary" onclick="goToStep(3)">Next</button>
</div>

<div class="step" id="step3">
  <label>Property Address</label>
  <input type="text" id="address" placeholder="Start typing your address...">
  <small style="color:#9fb3c8;font-size:13px;display:block;margin-top:4px;">Select from dropdown</small>
  <button class="primary" onclick="goToStep(4)">Next</button>
</div>

<div class="step" id="step4">
  <label>Roof Type</label>
  <div class="buttons">
    <button class="btn" onclick="selectOption(this, 'roofType', 'Asphalt')">Asphalt</button>
    <button class="btn" onclick="selectOption(this, 'roofType', 'Metal')">Metal</button>
    <button class="btn" onclick="selectOption(this, 'roofType', 'Tile')">Tile</button>
  </div>
  <button class="primary" onclick="goToStep(5)">Next</button>
</div>

<div class="step" id="step5">
  <label>Number of Stories</label>
  <div class="buttons">
    <button class="btn" onclick="selectOption(this, 'stories', '1')">1 Story</button>
    <button class="btn" onclick="selectOption(this, 'stories', '2')">2 Stories</button>
    <button class="btn" onclick="selectOption(this, 'stories', '3')">3+ Stories</button>
  </div>
  <button class="primary" onclick="submitForm()">Get My Estimate</button>
</div>

<div class="loading">
  <div class="spinner"></div>
  <h2>Calculating your estimate...</h2>
  <p>This may take 30-60 seconds</p>
</div>

<div class="result">
  <h2>Your Instant Estimate</h2>
  <div class="price" id="estimatePrice">$0</div>
  <p class="note">This is an estimated range based on satellite imagery. A professional inspection may reveal additional needs.</p>
</div>

</div>

<script>
// Form data
const formData = {
  firstName: '',
  email: '',
  address: '',
  roofType: '',
  stories: ''
};

// Google Maps Autocomplete
function initMap() {
  console.log('Google Maps loaded');
  const addressInput = document.getElementById('address');
  if (!addressInput) return;
  
  const autocomplete = new google.maps.places.Autocomplete(addressInput, {
    types: ['address'],
    componentRestrictions: { country: 'us' }
  });
  
  autocomplete.addListener('place_changed', () => {
    const place = autocomplete.getPlace();
    formData.address = place.formatted_address || addressInput.value;
    console.log('Address selected:', formData.address);
  });
}

window.initMap = initMap;

// Navigation
function goToStep(stepNum) {
  // Validate current step
  if (stepNum === 2) {
    formData.firstName = document.getElementById('firstName').value.trim();
    if (!formData.firstName) {
      alert('Please enter your first name');
      return;
    }
  }
  
  if (stepNum === 3) {
    formData.email = document.getElementById('email').value.trim();
    const emailInput = document.getElementById('email');
    if (!formData.email || !emailInput.checkValidity()) {
      alert('Please enter a valid email');
      return;
    }
  }
  
  if (stepNum === 4) {
    formData.address = document.getElementById('address').value.trim();
    if (!formData.address) {
      alert('Please enter your address');
      return;
    }
  }
  
  if (stepNum === 5) {
    if (!formData.roofType) {
      alert('Please select a roof type');
      return;
    }
  }
  
  // Hide all steps
  document.querySelectorAll('.step').forEach(step => step.classList.remove('active'));
  
  // Show target step
  document.getElementById('step' + stepNum).classList.add('active');
}

// Option selection
function selectOption(btn, field, value) {
  // Remove selected class from siblings
  btn.parentElement.querySelectorAll('.btn').forEach(b => b.classList.remove('selected'));
  
  // Add selected class
  btn.classList.add('selected');
  
  // Store value
  formData[field] = value;
  
  console.log('Selected:', field, '=', value);
}

// Form submission
async function submitForm() {
  if (!formData.stories) {
    alert('Please select number of stories');
    return;
  }
  
  console.log('=== SUBMITTING FORM ===');
  console.log('Form data:', formData);
  
  // Hide steps, show loading
  document.querySelectorAll('.step').forEach(step => step.classList.remove('active'));
  document.querySelector('.loading').classList.add('active');
  
  // Generate callback ID
  const callbackId = 'est_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
  console.log('Generated callbackId:', callbackId);
  
  // Prepare payload
  const payload = {
    firstName: formData.firstName,
    email: formData.email,
    address: formData.address,
    roofType: formData.roofType,
    stories: formData.stories,
    callbackId: callbackId,
    timestamp: new Date().toISOString()
  };
  
  console.log('Payload:', payload);
  
  try {
    // Submit to GHL
    const response = await fetch(
      'https://services.leadconnectorhq.com/hooks/FDGIykNfntzs46TT1VA7/webhook-trigger/d2467da0-757d-423f-ad12-32e10bc92127',
      {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      }
    );
    
    console.log('GHL Response:', response.status, response.statusText);
    
    if (!response.ok) {
      throw new Error('GHL webhook failed: ' + response.status);
    }
    
    console.log('✓ Submitted to GHL successfully');
    console.log('Starting polling...');
    
    // Start polling
    pollForResult(callbackId);
    
  } catch (error) {
    console.error('❌ Submission error:', error);
    document.querySelector('.loading').classList.remove('active');
    alert('Failed to submit. Please try again.');
    document.getElementById('step5').classList.add('active');
  }
}

// Polling function
async function pollForResult(callbackId) {
  let attempts = 0;
  const maxAttempts = 60; // 2 minutes
  
  const poll = async () => {
    attempts++;
    console.log(`Poll attempt ${attempts}/${maxAttempts}`);
    
    try {
      const response = await fetch(
        `https://roof-estimate-return-webhook-ge3l.vercel.app/api/get-result?callbackId=${callbackId}`
      );
      
      if (response.ok) {
        const result = await response.json();
        console.log('✓ RESULT RECEIVED:', result);
        
        // Show result
        document.querySelector('.loading').classList.remove('active');
        document.querySelector('.result').classList.add('active');
        document.getElementById('estimatePrice').textContent = 
          '$' + Number(result.totalEstimate).toLocaleString();
        
        return; // Stop polling
      }
      
      // Continue polling
      if (attempts < maxAttempts) {
        setTimeout(poll, 2000);
      } else {
        console.error('Polling timeout');
        document.querySelector('.loading').classList.remove('active');
        alert('Request timed out. Please try again.');
        document.getElementById('step5').classList.add('active');
      }
      
    } catch (error) {
      console.error('Polling error:', error);
      if (attempts < maxAttempts) {
        setTimeout(poll, 2000);
      }
    }
  };
  
  // Start polling after 5 seconds
  setTimeout(poll, 5000);
}
</script>

</body>
</html>
