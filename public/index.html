<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Instant Roof Estimate</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<script
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD5W9aPwPQQPFXHf4uzYeSAmC8nC15wXsM&libraries=places"
  defer
></script>

<style>
* { box-sizing: border-box; }
body {
  margin: 0;
  padding: 40px 16px;
  background: #0a0e14;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  color: #fff;
}
.card {
  max-width: 520px;
  margin: auto;
  background: linear-gradient(180deg, #0f1b2d, #0c1624);
  border-radius: 16px;
  padding: 32px;
  border: 1px solid #243246;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
}
h1 {
  text-align: center;
  margin: 0 0 8px 0;
  font-size: 28px;
  font-weight: 700;
}
.subtitle {
  text-align: center;
  color: #9fb3c8;
  margin-bottom: 24px;
  font-size: 15px;
}
.step {
  display: none;
}
.step.active {
  display: block;
  animation: fadeIn 0.3s ease-in;
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
label {
  display: block;
  margin-bottom: 8px;
  font-weight: 500;
  font-size: 15px;
}
input {
  width: 100%;
  padding: 14px 16px;
  border-radius: 8px;
  background: #0a0e14;
  border: 1px solid #2c3e55;
  color: #fff;
  font-size: 15px;
  transition: border-color 0.2s;
}
input:focus {
  outline: none;
  border-color: #3bbcff;
}
.buttons {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
  margin-top: 12px;
}
.btn {
  padding: 14px;
  border-radius: 8px;
  background: #0a0e14;
  border: 2px solid #2c3e55;
  color: #fff;
  cursor: pointer;
  font-size: 15px;
  font-weight: 500;
  transition: all 0.2s;
}
.btn:hover {
  border-color: #3bbcff;
  background: rgba(59, 188, 255, 0.1);
}
.btn.selected {
  background: #3bbcff;
  border-color: #3bbcff;
  color: #0a0e14;
  font-weight: 600;
}
.primary {
  margin-top: 20px;
  width: 100%;
  padding: 16px;
  background: linear-gradient(90deg, #3bbcff, #1f8fff);
  border: none;
  border-radius: 8px;
  color: #fff;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: transform 0.2s, box-shadow 0.2s;
}
.primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 16px rgba(59, 188, 255, 0.4);
}
.loading, .result {
  text-align: center;
  display: none;
  padding: 40px 20px;
}
.spinner {
  border: 3px solid #2c3e55;
  border-top: 3px solid #3bbcff;
  border-radius: 50%;
  width: 50px;
  height: 50px;
  animation: spin 1s linear infinite;
  margin: 0 auto 20px;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
.price {
  font-size: 48px;
  font-weight: 700;
  color: #3bbcff;
  margin-top: 16px;
  text-shadow: 0 2px 8px rgba(59, 188, 255, 0.3);
}
</style>
</head>

<body>
<div class="card">

<h1>Instant Roof Estimate</h1>
<div class="subtitle">Answer a few quick questions</div>

<div class="step active">
  <label>First Name</label>
  <input id="firstName" placeholder="Enter your first name" />
  <button class="primary" onclick="next()">Next</button>
</div>

<div class="step">
  <label>Email</label>
  <input id="email" type="email" placeholder="your@email.com" />
  <button class="primary" onclick="next()">Next</button>
</div>

<div class="step">
  <label>Property Address</label>
  <input id="address" placeholder="Start typing address..." />
  <small style="color: #9fb3c8; font-size: 13px; margin-top: 6px; display: block;">Select from dropdown</small>
  <button class="primary" onclick="next()">Next</button>
</div>

<div class="step">
  <label>Roof Type</label>
  <div class="buttons">
    <button class="btn" onclick="pick(this,'Asphalt')">Asphalt</button>
    <button class="btn" onclick="pick(this,'Metal')">Metal</button>
    <button class="btn" onclick="pick(this,'Tile')">Tile</button>
  </div>
  <button class="primary" onclick="next()">Next</button>
</div>

<div class="step">
  <label>Stories</label>
  <div class="buttons">
    <button class="btn" onclick="pick(this,'1')">1 Story</button>
    <button class="btn" onclick="pick(this,'2')">2 Stories</button>
    <button class="btn" onclick="pick(this,'3')">3+ Stories</button>
  </div>
  <button class="primary" onclick="submitForm()">Get My Estimate</button>
</div>

<div class="loading">
  <div class="spinner"></div>
  <h3>Calculating your estimate…</h3>
  <p style="color: #9fb3c8; margin-top: 12px;">This may take 30-60 seconds</p>
</div>

<div class="result">
  <h2 style="margin: 0 0 8px 0;">Your Instant Estimate</h2>
  <div class="price" id="price">$0</div>
  <p style="color: #9fb3c8; margin-top: 16px; font-size: 14px;">This is an estimated range. A professional inspection may reveal additional needs.</p>
</div>

</div>

<script>
let step = 0;
const steps = document.querySelectorAll('.step');

const data = {
  firstName: '',
  email: '',
  address: '',
  roofType: '',
  stories: ''
};

function next() {
  if (step === 0) {
    data.firstName = firstName.value.trim();
    if (!data.firstName) return alert('Please enter your first name');
  }
  if (step === 1) {
    data.email = email.value.trim();
    if (!data.email || !email.checkValidity()) return alert('Please enter a valid email');
  }
  if (step === 2) {
    data.address = address.value.trim();
    if (!data.address) return alert('Please select an address from the dropdown');
  }
  if (step === 3) {
    if (!data.roofType) return alert('Please select a roof type');
  }
  
  steps[step].classList.remove('active');
  step++;
  steps[step].classList.add('active');
}

function pick(btn, val) {
  btn.parentElement.querySelectorAll('.btn').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  if (step === 3) data.roofType = val;
  if (step === 4) data.stories = val;
}

async function submitForm() {
  if (!data.stories) return alert('Please select number of stories');
  
  console.log('=== SUBMITTING TO GHL ===');
  console.log('Data:', data);
  
  // Hide form, show loading
  steps.forEach(s => s.style.display = 'none');
  document.querySelector('.loading').style.display = 'block';

  // Generate unique callback ID
  const callbackId = 'est_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
  console.log('Generated callbackId:', callbackId);
  
  const payload = {
    firstName: data.firstName,
    email: data.email,
    address: data.address,
    roofType: data.roofType,
    stories: data.stories,
    callbackId: callbackId,
    timestamp: new Date().toISOString()
  };

  console.log('Payload:', payload);

  try {
    // Submit to GHL
    const res = await fetch(
      'https://services.leadconnectorhq.com/hooks/FDGIykNfntzs46TT1VA7/webhook-trigger/d2467da0-757d-423f-ad12-32e10bc92127',
      {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      }
    );

    console.log('GHL Response:', res.status);

    if (!res.ok) {
      throw new Error('GHL webhook failed: ' + res.status);
    }

    console.log('✓ Submitted to GHL, starting polling...');
    
    // Start polling for results
    let pollAttempts = 0;
    const maxPolls = 60; // 2 minutes max
    
    const pollForResult = async () => {
      pollAttempts++;
      console.log(`Polling attempt ${pollAttempts}/${maxPolls}...`);
      
      try {
        const pollRes = await fetch(
          `https://roof-estimate-return-webhook-ge3l.vercel.app/api/get-result?callbackId=${callbackId}`
        );
        
        if (pollRes.ok) {
          const result = await pollRes.json();
          
          console.log('✓ RESULT RECEIVED:', result);
          
          // Display result
          document.querySelector('.loading').style.display = 'none';
          document.querySelector('.result').style.display = 'block';
          document.getElementById('price').innerText = 
            '$' + Number(result.totalEstimate).toLocaleString();
          
          return; // Stop polling
        }
        
        // Continue polling if not found
        if (pollAttempts < maxPolls) {
          setTimeout(pollForResult, 2000); // Poll every 2 seconds
        } else {
          console.error('Polling timeout');
          document.querySelector('.loading').style.display = 'none';
          alert('Request timed out. Please try again.');
          steps[4].style.display = 'block';
          steps[4].classList.add('active');
        }
        
      } catch (pollError) {
        console.error('Polling error:', pollError);
        if (pollAttempts < maxPolls) {
          setTimeout(pollForResult, 2000);
        }
      }
    };
    
    // Start polling after 5 seconds (give GHL time to process)
    setTimeout(pollForResult, 5000);

  } catch (error) {
    console.error('❌ Error:', error);
    document.querySelector('.loading').style.display = 'none';
    alert('Unable to submit. Please try again.');
    steps[4].style.display = 'block';
    steps[4].classList.add('active');
  }
}

// Google Places Autocomplete
window.addEventListener('load', () => {
  if (typeof google === 'undefined') {
    console.warn('Google Maps API not loaded');
    return;
  }
  
  const ac = new google.maps.places.Autocomplete(
    document.getElementById('address'),
    { types: ['address'], componentRestrictions: { country: 'us' } }
  );
  
  ac.addListener('place_changed', () => {
    const p = ac.getPlace();
    data.address = p.formatted_address || '';
    console.log('Address selected:', data.address);
  });
});
</script>
</body>
</html>
