<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Instant Roof Estimate</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<script
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD5W9aPwPQQPFXHf4uzYeSAmC8nC15wXsM&libraries=places"
  defer
></script>

<style>
* { box-sizing: border-box; }
body {
  margin: 0;
  padding: 40px 16px;
  background:#0a0e14;
  font-family: system-ui, sans-serif;
  color:#fff;
}
.card {
  max-width:520px;
  margin:auto;
  background:linear-gradient(180deg,#0f1b2d,#0c1624);
  border-radius:16px;
  padding:28px;
  border:1px solid #243246;
}
h1{text-align:center;margin:0;}
.subtitle{text-align:center;color:#9fb3c8;margin-bottom:16px;}
.step{display:none;}
.step.active{display:block;}
label{display:block;margin-bottom:6px;}
input{
  width:100%;padding:14px;border-radius:8px;
  background:#0a0e14;border:1px solid #2c3e55;color:#fff;
}
.buttons{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;}
.btn{
  padding:12px;border-radius:8px;background:#0a0e14;
  border:1px solid #2c3e55;color:#fff;cursor:pointer;
}
.btn.selected{background:#3bbcff;border-color:#3bbcff;}
.primary{
  margin-top:16px;width:100%;padding:14px;
  background:linear-gradient(90deg,#3bbcff,#1f8fff);
  border:none;border-radius:8px;color:#fff;font-size:16px;cursor:pointer;
}
.loading,.result{text-align:center;display:none;}
.price{font-size:42px;color:#3bbcff;margin-top:16px;}
</style>
</head>

<body>
<div class="card">

<h1>Instant Roof Estimate</h1>
<div class="subtitle">Answer a few quick questions</div>

<div class="step active">
  <label>First Name</label>
  <input id="firstName" />
  <button class="primary" onclick="next()">Next</button>
</div>

<div class="step">
  <label>Email</label>
  <input id="email" type="email"/>
  <button class="primary" onclick="next()">Next</button>
</div>

<div class="step">
  <label>Property Address</label>
  <input id="address" placeholder="Start typing address..."/>
  <button class="primary" onclick="next()">Next</button>
</div>

<div class="step">
  <label>Roof Type</label>
  <div class="buttons">
    <button class="btn" onclick="pick(this,'Asphalt')">Asphalt</button>
    <button class="btn" onclick="pick(this,'Metal')">Metal</button>
    <button class="btn" onclick="pick(this,'Tile')">Tile</button>
  </div>
  <button class="primary" onclick="next()">Next</button>
</div>

<div class="step">
  <label>Stories</label>
  <div class="buttons">
    <button class="btn" onclick="pick(this,1)">1 Story</button>
    <button class="btn" onclick="pick(this,2)">2 Stories</button>
    <button class="btn" onclick="pick(this,3)">3+ Stories</button>
  </div>
  <button class="primary" onclick="submitForm()">Get My Estimate</button>
</div>

<div class="loading">Calculating your estimate…</div>
<div class="result">
  <h2>Your Instant Estimate</h2>
  <div class="price" id="price">$0</div>
</div>

</div>

<script>
let step=0;
const steps=document.querySelectorAll('.step');

const data={
  firstName:'',
  email:'',
  address:'',
  roofType:'',
  stories:''
};

function next(){
  if(step===0) {
    data.firstName=firstName.value.trim();
    if(!data.firstName) return alert('Please enter your first name');
  }
  if(step===1) {
    data.email=email.value.trim();
    if(!data.email) return alert('Please enter your email');
  }
  if(step===2) {
    data.address=address.value.trim();
    if(!data.address) return alert('Please select an address from the dropdown');
  }
  if(step===3) {
    if(!data.roofType) return alert('Please select a roof type');
  }
  
  steps[step].classList.remove('active');
  step++;
  steps[step].classList.add('active');
}

function pick(btn,val){
  btn.parentElement.querySelectorAll('.btn').forEach(b=>b.classList.remove('selected'));
  btn.classList.add('selected');
  if(step===3) data.roofType=val;
  if(step===4) data.stories=val;
}

async function submitForm(){
  if(!data.stories) return alert('Please select number of stories');
  
  console.log('Submitting data:', data);
  
  document.querySelector('.loading').style.display='block';
  steps.forEach(s=>s.style.display='none');

  // Generate unique callback ID
  const callbackId = 'est_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
  
  const payload = {
    firstName: data.firstName,
    email: data.email,
    address: data.address,
    roofType: data.roofType,
    stories: data.stories,
    callbackId: callbackId,
    timestamp: new Date().toISOString()
  };

  console.log('Sending payload:', payload);

  try {
    const res = await fetch(
      'https://services.leadconnectorhq.com/hooks/FDGIykNfntzs46TT1VA7/webhook-trigger/EO7CUMjucJlR9uy7SuDa',
      {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(payload)
      }
    );

    console.log('Response status:', res.status);
    const responseText = await res.text();
    console.log('Response body:', responseText);

    if(!res.ok) {
      throw new Error('Webhook request failed: ' + res.status);
    }

    // Show loading message while waiting for callback
    document.querySelector('.loading').innerHTML = 'Calculating your estimate…<br><small style="margin-top:8px;display:block;color:#9fb3c8;">This may take 30-60 seconds</small>';
    
    // Set up callback listener
    window.handleEstimateCallback = function(result) {
      console.log('Callback received:', result);
      document.querySelector('.loading').style.display='none';
      document.querySelector('.result').style.display='block';
      document.getElementById('price').innerText = 
        `$${Number(result.totalEstimate).toLocaleString()}`;
    };

  } catch(error) {
    console.error('Error:', error);
    document.querySelector('.loading').style.display='none';
    alert('Unable to submit request. Please try again.');
    steps[4].style.display='block';
    steps[4].classList.add('active');
  }
}

window.addEventListener('load',()=>{
  const ac=new google.maps.places.Autocomplete(
    document.getElementById('address'),
    {types:['address'],componentRestrictions:{country:'us'}}
  );
  ac.addListener('place_changed',()=>{
    const p=ac.getPlace();
    data.address=p.formatted_address||'';
    console.log('Address selected:', data.address);
  });
});
</script>
</body>
</html>
